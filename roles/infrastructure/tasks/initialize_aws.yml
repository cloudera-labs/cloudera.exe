---

# Copyright 2021 Cloudera, Inc. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- name: Set fact for Log and Data locations
  ansible.builtin.set_fact:
    infra__aws_storage_locations: "{{ infra__aws_storage_locations | default([]) | union([storage_location]) }}"
  vars:
    storage_location:
      bucket: "{{ __aws_storage_location_item.bucket }}"
      path: "{{ __aws_storage_location_item.path }}"
  loop_control:
    loop_var: __aws_storage_location_item
  loop:
    - bucket: "{{ infra__storage_name }}"
      path: "{{ infra__logs_path }}"
    - bucket: "{{ infra__storage_name }}"
      path: "{{ infra__ranger_audit_path }}"

# Will discover VPC ID as well
- name: Confirm existing AWS Public and Private Subnet details if provided
  when: infra__aws_private_subnet_ids or infra__aws_public_subnet_ids
  block:
    - name: Handle existing AWS Private Subnets
      when: infra__aws_private_subnet_ids
      block:
        - name: Fetch AWS private subnets info
          amazon.aws.ec2_vpc_subnet_info:
            region: "{{ infra__region }}"
            subnet_ids: "{{ infra__aws_private_subnet_ids }}"
          register: __aws_private_subnets_info

        - name: Confirm AWS private subnet AZ count and public IP assignment
          ansible.builtin.assert:
            that:
              - __aws_private_subnets_info.subnets | map(attribute='availability_zone') | list | unique | count >= infra__aws_vpc_az_count | int
              - __aws_private_subnets_info.subnets | map(attribute='map_public_ip_on_launch') | reject() | length > 0
            fail_msg: "The private subnets should be provided from at least 2 AZs and should have public IP addressing disabled."
            quiet: yes

        - name: Generate Private Subnet details for update
          ansible.builtin.set_fact:
            infra__vpc_private_subnets_info: "{{ infra__vpc_private_subnets_info | default([]) | union([entry]) }}"
          loop_control:
            loop_var: __private_subnet_item
            index_var: __private_subnet_idx
          loop: "{{ __aws_private_subnets_info.subnets }}"
          vars:
            entry:
              name: "{{ __private_subnet_item.tags['Name'] | default([infra__namespace, infra__vpc_private_subnets_suffix, __private_subnet_idx|string] | join('-')) }}"
              cidr: "{{ __private_subnet_item.cidr_block }}"
              tags:
                "kubernetes.io/role/internal-elb": "1"
                "Name": "{{ __private_subnet_item.tags['Name'] | default([infra__namespace, infra__vpc_private_subnets_suffix, __private_subnet_idx|string] | join('-')) }}"

        - name: Set facts for existing AWS Private Subnet IDs and associate VPC ID
          ansible.builtin.set_fact:
            infra__aws_subnet_ids: "{{ infra__aws_private_subnet_ids }}"
            infra__aws_vpc_id: "{{ __aws_private_subnets_info.subnets | map(attribute='vpc_id') | list | first }}"

    - name: Handle existing AWS Public Subnets
      when: infra__aws_public_subnet_ids
      block:
        - name: Fetch AWS Public Subnets info 
          amazon.aws.ec2_vpc_subnet_info:
            region: "{{ infra__region }}"
            subnet_ids: "{{ infra__aws_public_subnet_ids }}"
          register: __aws_public_subnets_info

        - name: Confirm AWS Public Subnet AZ count and public IP assignment
          ansible.builtin.assert:
            that:
              - __aws_public_subnets_info.subnets | map(attribute='availability_zone') | list | unique | count >= infra__aws_vpc_az_count | int
              - __aws_public_subnets_info.subnets | map(attribute='map_public_ip_on_launch') | select() | length > 0
            fail_msg: "The public subnets should be associated with at least 2 AZs and should have public IP addressing enabled."
            quiet: yes

        - name: Confirm additional AWS Public Subnet AZ count if providing Public Endpoint access
          when: infra__public_endpoint_access
          ansible.builtin.assert:
            that: 
              - infra__aws_private_subnet_ids
              - infra__aws_public_subnet_ids | unique | count >= __aws_private_subnets_info.subnets | map(attribute='availability_zone') | list | unique | count
            fail_msg: "The number of public subnets should be at least as many as the number of associated AZs of the private subnets."
            quiet: yes

        - name: Generate Public Subnet details for creation
          when: not __aws_public_subnets_info.subnets
          ansible.builtin.set_fact:
            infra__vpc_public_subnets_info: "{{ infra__vpc_public_subnets_info | default([]) | union([entry]) }}"
          loop_control:
            loop_var: __public_subnet_item
            index_var: __public_subnet_idx
          loop: "{{ __aws_public_subnets_info.subnets }}"
          vars:
            entry:
              name: "{{ __public_subnet_item.tags['Name'] | default([infra__namespace, infra__vpc_public_subnets_suffix, __public_subnet_idx|string] | join('-')) }}"
              cidr: "{{ __public_subnet_item.cidr_block }}"
              tags:
                "kubernetes.io/role/elb": "1"
                "Name": "{{ __public_subnet_item.tags['Name'] | default([infra__namespace, infra__vpc_public_subnets_suffix, __public_subnet_idx|string] | join('-')) }}"

        - name: Set facts for existing AWS Public Subnet IDs
          ansible.builtin.set_fact:
            infra__aws_public_subnet_ids: "{{ infra__aws_public_subnet_ids }}"
            infra__aws_subnet_ids: "{{ infra__aws_subnet_ids | default([]) | union(infra__aws_public_subnet_ids) }}"
            infra__aws_vpc_id: "{{ __aws_public_subnets_info.subnets | map(attribute='vpc_id') | list | first }}"

    - name: Confirm facts for AWS Subnets
      ansible.builtin.set_fact:
        infra__vpc_private_subnets_info: "{{ infra__vpc_private_subnets_info | default([]) }}"
        infra__vpc_public_subnets_info: "{{ infra__vpc_public_subnets_info | default([]) }}"

- name: Query existing AWS VPC if provided
  when: infra__aws_vpc_id != ""
  block:
    - name: Confirm AWS VPC ID
      when: no # Skipped due to https://github.com/boto/boto3/issues/2929
      amazon.aws.ec2_vpc_net_info:
        region: "{{ infra__region }}"
        vpc_ids: "{{ infra__aws_vpc_id }}"
      register: __aws_vpc_list
      failed_when: not __aws_vpc_list.vpcs

    - name: Set facts for existing AWS VPC CIDR block and Name
      when: no # Skipped due to https://github.com/boto/boto3/issues/2929
      ansible.builtin.set_fact:
        infra__vpc_cidr: "{{ __aws_vpc_list.vpcs[0].cidr_block }}"
        # infra__vpc_name: "{{ __aws_vpc_list.vpcs[0].tags['Name'] }}"

    - name: Confirm AWS VPC ID (CLI version)
      ansible.builtin.command: "aws ec2 describe-vpcs --region {{ infra__region }} --vpc-id {{ infra__aws_vpc_id }}"
      register: __aws_vpc_list
      failed_when: not (__aws_vpc_list.stdout | from_json)['Vpcs']

    - name: Set facts for existing AWS VPC CIDR block and Name (CLI version)
      when: (__aws_vpc_list.stdout | from_json)['Vpcs']['Tags']
      ansible.builtin.set_fact:
        infra__vpc_cidr: "{{ (__aws_vpc_list.stdout | from_json)['Vpcs'] | map(attribute='CidrBlock') | list | first }}"
        #infra__vpc_name: "{{ (__aws_vpc_list.stdout | from_json)['Vpcs'] | map(attribute='Tags') | flatten | selectattr('Key', 'eq', 'Name') | map(attribute='Value') | list | first }}"

    - name: Set facts for existing AWS VPC Name (CLI version)
      when: not (__aws_vpc_list.stdout | from_json)['Vpcs']['Tags']
      ansible.builtin.set_fact:
        infra__vpc_cidr: "{{ (__aws_vpc_list.stdout | from_json)['Vpcs'] | map(attribute='CidrBlock') | list | first }}"

- name: Discover possible existing AWS VPC details
  when: infra__aws_vpc_id == ""
  block:
    - name: Query AWS VPCs by unique name and CIDR
      when: no # Skipped due to https://github.com/boto/boto3/issues/2929
      amazon.aws.ec2_vpc_net_info:
        region: "{{ infra__region }}"
        filters:
          "tag:Name": "{{ infra__vpc_name }}*"
          cidr: "{{ infra__vpc_cidr }}"
      register: __aws_vpc_list_discovered

    - name: Check VPC list for singular response
      when: no # Skipped due to https://github.com/boto/boto3/issues/2929
      #when: __aws_vpc_list_discovered.vpcs | count > 1
      ansible.builtin.fail:
        msg: "Found more than one VPC matching name, {{ infra__vpc_name }}, and CIDR, {{ infra__vpc_cidr }}."

    - name: Set fact for AWS VPC ID parameter on a unique response
      when: no # Skipped due to https://github.com/boto/boto3/issues/2929
      #when: __aws_vpc_list_discovered.vpcs | count == 1
      ansible.builtin.set_fact:
        infra__aws_vpc_id: "{{ __aws_vpc_list_discovered.vpcs[0].vpc_id }}"
        #infra__vpc_cidr: "{{ __aws_vpc_list_discovered.vpcs[0].cidr_block }}"
        #infra__vpc_name: "{{ __aws_vpc_list_discovered.vpcs[0].tags['Name'] }}"

    - name: Query AWS VPC ID by unique name and CIDR (CLI version)
      ansible.builtin.command: "aws ec2 describe-vpcs --region {{ infra__region }} --filters Name=cidr,Values={{ infra__vpc_cidr }} Name=tag:Name,Values={{ infra__vpc_name }}"
      register: __aws_vpc_list_discovered
      #failed_when: not (__aws_vpc_list_discovered.stdout | from_json)['Vpcs']

    - name: Check VPC list for singular response (CLI version)
      when: (__aws_vpc_list_discovered.stdout | from_json)['Vpcs'] | count > 1
      ansible.builtin.fail:
        msg: "Found more than one VPC matching name, {{ infra__vpc_name }}, and CIDR, {{ infra__vpc_cidr }}."

    - name: Set fact for AWS VPC ID parameter on a unique response (CLI version)
      when: (__aws_vpc_list_discovered.stdout | from_json)['Vpcs'] | count == 1
      ansible.builtin.set_fact:
        infra__aws_vpc_id: "{{ (__aws_vpc_list_discovered.stdout | from_json)['Vpcs'] | map(attribute='VpcId') | list | first }}"
        #infra__vpc_cidr: "{{ __aws_vpc_list_discovered.vpcs[0].cidr_block }}"
        #infra__vpc_name: "{{ __aws_vpc_list_discovered.vpcs[0].tags['Name'] }}"

- name: Fetch EC2 Instance info for Dynamic Inventory Nodes
  register: __infra_dynamic_inventory_discovered
  community.aws.ec2_instance_info:
    region: "{{ infra__region }}"
    filters: "{{ __filters | items2dict }}"
  vars:
    __filters:
      - key: "tag:{{ infra__dynamic_inventory_tag_key }}"
        value: "{{ infra__dynamic_inventory_tag_value }}*"

- name: Fetch EC2 Instance info for Utility VM
  register: __infra_utility_compute_discovered
  community.aws.ec2_instance_info:
    region: "{{ infra__region }}"
    filters: "{{ __filters | items2dict }}"
  vars:
    __filters:
      - key: "tag:Name"
        value: "{{ infra__namespace }}*"

- name: Set discovered compute inventory for later action
  ansible.builtin.set_fact:
    infra__discovered_compute_inventory: "{{ __infra_dynamic_inventory_discovered.instances + __infra_utility_compute_discovered.instances }}"

# Note that the download mirror is localised to the Account and Region deliberately
- name: Determine Download Mirror Bucket Name
  when:
    - not infra__utlity_bucket_name
    - infra__create_utility_service | bool
  ansible.builtin.set_fact:
    infra__utlity_bucket_name: "{{ [ infra__download_mirror_bucket_prefix, infra__aws_caller_info.account, infra__region ] | join('-') }}"

# These need to be set as facts on the Ansible Controller to be picked up later
- name: Set Download Mirror output artefacts
  ansible.builtin.set_fact:
    infra__type: "{{ infra__type }}"
    infra__region: "{{ infra__region }}"

- name: Discover VPC Dependencies during Purge cleanup
  when:
    - infra__force_teardown | bool
    - infra__aws_vpc_id | length > 1
  block:
    - name: Fetch Network Interfaces in VPC
      register: __infra_vpc_enis
      amazon.aws.ec2_eni_info:
        region: "{{ infra__region }}"
        filters: "{{ __filters | items2dict }}"
      vars:
        __filters:
          - key: "vpc-id"
            value: "{{ infra__aws_vpc_id }}"

    - name: List all EC2 instances in VPC
      register: __infra_vpc_ec2_instances
      community.aws.ec2_instance_info:
        region: "{{ infra__region }}"
        filters: "{{ __filters | items2dict }}"
      vars:
        __filters:
          - key: "vpc-id"
            value: "{{ infra__aws_vpc_id }}"

    - name: Update discovered compute inventory for later action
      ansible.builtin.set_fact:
        infra__discovered_compute_inventory: "{{ infra__discovered_compute_inventory + __infra_vpc_ec2_instances.instances }}"

    - name: List EKS Clusters
      register: __infra_eks_cluster_list
      command: "aws eks list-clusters"

    - name: Describe all EKS Clusters
      register: __infra_eks_cluster_details
      ansible.builtin.command: "aws eks describe-cluster --name {{ __infra_eks_cluster_item }}"
      loop_control:
        loop_var: __infra_eks_cluster_item
      loop: "{{ __infra_eks_cluster_list.stdout | from_json | community.general.json_query('clusters') }} "

    - name: Filter EKS by this VPC
      ansible.builtin.set_fact:
        __infra_vpc_eks_cluster_names: "{{ __infra_vpc_eks_cluster_names | d([]) + [__infra_lookup_name] }}"
      when: __infra_lookup_vpc == infra__aws_vpc_id
      vars:
        __infra_lookup_vpc: "{{ __infra_eks_cluster_detail_item.stdout | from_json | community.general.json_query('cluster.resourcesVpcConfig.vpcId') }}"
        __infra_lookup_name: "{{ __infra_eks_cluster_detail_item.stdout | from_json | community.general.json_query('cluster.name') }}"
      loop: "{{ __infra_eks_cluster_details.results }}"
      loop_control:
        loop_var: __infra_eks_cluster_detail_item

    - name: List all ASGs in region
      register: __infra_ec2_asg_list
      community.aws.ec2_asg_info:
        region: "{{ infra__region }}"

    - name: Fetch list of all Subnets in VPC
      register: __infra_disc_subnets
      amazon.aws.ec2_vpc_subnet_info:
        filters:
          vpc-id: "{{ infra__aws_vpc_id }}"

    - name: Filter ASGs by Subnets in this VPC
      when:
        - __infra_ec2_asg_list.results | length > 0
        - __infra_asg_filter_item.vpc_zone_identifier in __infra_vpc_subnet_ids
      ansible.builtin.set_fact:
        __infra_aws_asg_names: "{{ __infra_aws_asg_names | default([]) + [__infra_asg_filter_item.auto_scaling_group_name] }}"
      vars:
        __infra_vpc_subnet_ids: "{{ __infra_disc_subnets.subnets | community.general.json_query('[*].id') | list | unique }}"
        __infra_vpc_sg_ids: "{{ __infra_disc_sgs.security_groups | community.general.json_query('[*].group_id') | list | unique }}"
      loop: "{{ __infra_ec2_asg_list.results }}"
      loop_control:
        loop_var: __infra_asg_filter_item

    - name: List all AWS ELBs in region
      community.aws.ec2_elb_info:
        region: "{{ infra__region }}"
      register: __infra_ec2_elbs

    - name: Filter list of ELBS to match our VPC
      when:
        - __infra_ec2_elbs.elbs | length > 0
        - __infra_ec2_elb_item.vpc_id == infra__aws_vpc_id
      ansible.builtin.set_fact:
        __infra_ec2_elb_names: "{{ __infra_ec2_elb_names | default([]) + [__infra_ec2_elb_item.name] }}"
      loop: "{{ __infra_ec2_elbs.elbs }}"
      loop_control:
        loop_var: __infra_ec2_elb_item

    - name: List NAT gatways in VPC
      community.aws.ec2_vpc_nat_gateway_info:
        region: "{{ infra__region }}"
        filters:
          vpc-id: "{{ infra__aws_vpc_id }}"
      register: __infra_aws_nat_gateways

    - name: List all Security Groups in VPC
      register:  __infra_aws_sgs
      amazon.aws.ec2_group_info:
        region: "{{ infra__region }}"
        filters:
          vpc-id: "{{ infra__aws_vpc_id }}"

    - name: List all Route tables in VPC
      register: __infra_aws_rtbs
      community.aws.ec2_vpc_route_table_info:
        region: "{{ infra__region }}"
        filters:
          vpc-id: "{{ infra__aws_vpc_id }}"

- name: Discover Storage during Purge cleanup
  when:
    - infra__force_teardown | bool
  block:
    - name: List AWS EBS Volumes
      register: __infra_aws_ebs_vols
      amazon.aws.ec2_vol_info:
        region: "{{ infra__region }}"
        filters:
          status: available

    - name: Check for Orphaned EFS matching Namespace
      register: __infra_efs_fs
      community.aws.efs_info:
        region: "{{ infra__region }}"
        tags:
          Environment: "{{ infra__env_name }}"
