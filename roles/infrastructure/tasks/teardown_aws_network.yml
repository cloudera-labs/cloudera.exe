---

# Copyright 2021 Cloudera, Inc. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# When infra__aws_subnet_ids is True, then only delete SGs, because the network is not "owned"
# Otherwise, delete it all unless told otherwise
# Note that if the VPC is not shared, but is supplied via direct VpcId or discovered via Name/CIDR, the role will attempt to destroy it

- name: Tear down AWS Security Groups
  when: infra__teardown_deletes_network and infra__aws_vpc_id
  amazon.aws.ec2_group:
    region: "{{ infra__region }}"
    vpc_id: "{{ infra__aws_vpc_id }}"
    name: "{{ __security_group_name_item }}"
    state: absent
  loop_control:
    loop_var: __security_group_name_item
  loop:
    - "{{ infra__security_group_knox_name }}"
    - "{{ infra__security_group_default_name }}"

- name: Tear down AWS Network
  when: infra__teardown_deletes_network and infra__aws_vpc_id and not infra__aws_subnet_ids
  block:
    - name: Remove the AWS Private Network
      when: infra__tunnel
      block:
        - name: Delete the AWS Private Route Tables
          community.aws.ec2_vpc_route_table:
            vpc_id: "{{ infra__aws_vpc_id }}"
            region: "{{ infra__region }}"
            lookup: tag
            tags: "{{ { 'Name': '-'.join([infra__aws_private_route_table_name, __aws_private_subnet_id_index | string])} }}"
            state: absent
          loop_control:
            index_var: __aws_private_subnet_id_index
          loop: "{{ infra__vpc_private_subnet_cidrs }}"

        - name: List all managed AWS NAT Gateways
          community.aws.ec2_vpc_nat_gateway_info:
            region: "{{ infra__region }}"
            filters:
              vpc-id: "{{ infra__aws_vpc_id }}"
          register: __aws_all_ngws

        - name: Delete associated AWS NAT Gateways
          community.aws.ec2_vpc_nat_gateway:
            state: absent
            region: "{{ infra__region }}"
            wait: true
            nat_gateway_id: "{{ item.nat_gateway_id }}"
            release_eip: true
          register: __aws_ngw_teardown
          loop_control:
            label: "{{ item.nat_gateway_id }}"
          loop: "{{ __aws_all_ngws.result }}"
          ignore_errors: true

        - name: Check if AWS NAT Gateways deleted succesfully
          when: __aws_ngw_teardown is defined and __aws_ngw_teardown.results is defined and __aws_ngw_teardown.results | count > 0
          ansible.builtin.fail:
            msg: "Failed to delete a NAT gateway"
          failed_when: item.rc is defined and item.rc != 1 and ('InvalidAllocationID.NotFound' in item.module_stderr)
          loop: "{{ __aws_ngw_teardown.results }}"

    - name: Remove all AWS VPC Subnets
      amazon.aws.ec2_vpc_subnet:
        region: "{{ infra__region }}"
        vpc_id: "{{ infra__aws_vpc_id }}"
        cidr: "{{ __aws_subnet_item }}"
        state: absent
      loop_control:
        loop_var: __aws_subnet_item
        index_var: __aws_subnet_index
      loop: "{{ infra__vpc_public_subnet_cidrs | union(infra__vpc_private_subnet_cidrs) }}"

    - name: Remove AWS Internet Gateway (IGW)
      community.aws.ec2_vpc_igw:
        region: "{{ infra__region }}"
        vpc_id: "{{ infra__aws_vpc_id }}"
        state: absent
        tags:
          Name: "{{ infra__aws_igw_name }}"

    - name: Remove AWS VPC
      amazon.aws.ec2_vpc_net:
        region: "{{ infra__region }}"
        name: "{{ infra__vpc_name }}"
        cidr_block: "{{ infra__vpc_cidr }}"
        state: absent