---

# Copyright 2021 Cloudera, Inc. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- name: Set up AWS VPC
  when: not infra__aws_vpc_id
  block:
    - name: Create AWS VPC
      amazon.aws.ec2_vpc_net:
        region: "{{ infra__region }}"
        name: "{{ infra__vpc_name }}"
        cidr_block: "{{ infra__vpc_cidr }}"
        tags: "{{ infra__tags }}" # TODO - Filter out name, per module warning
        state: present
      register: __aws_vpc_info

    - name: Set fact for AWS VPC ID
      when: not infra__aws_vpc_id
      ansible.builtin.set_fact:
        infra__aws_vpc_id: "{{ __aws_vpc_info.vpc.id }}"

- name: Update existing AWS VPC
  when: infra__aws_vpc_id
  block:
    - name: Update AWS VPC
      when: no # Skipped due to https://github.com/boto/boto3/issues/2929
      amazon.aws.ec2_vpc_net:
        region: "{{ infra__region }}"
        name: "{{ infra__vpc_name }}"
        cidr_block: "{{ infra__vpc_cidr }}"
        tags: "{{ infra__tags }}" # TODO - Filter out name, per module warning
        state: present
      register: __aws_vpc_info

    - name: Prepare AWS VPC tags (CLI version)
      ansible.builtin.set_fact:
        __aws_vpc_tags: "{{ __aws_vpc_tags | default([]) | union([tag_entry]) }}"
      vars:
        tag_entry: "Key={{ __tag.key }},Value={{ __tag.value }}"
      loop: "{{ infra__tags }}"
      loop_control:
        loop_var: __tag

    - name: Update AWS VPC (CLI version)
      ansible.builtin.command: "aws ec2 create-tags --region {{ infra__region }} --resources {{ infra__aws_vpc_id }} --tags {{ __aws_vpc_tags | join(' ') }}"

- name: Update existing AWS VPC Public and Private Subnets
  when: infra__aws_subnet_ids is defined
  amazon.aws.ec2_vpc_subnet:
    region: "{{ infra__region }}"
    vpc_id: "{{ infra__aws_vpc_id }}"
    cidr: "{{ __aws_subnet_item.cidr }}"
    state: present
    tags: "{{ infra__tags | combine(__aws_subnet_item.tags, recursive=True) }}"
  loop_control:
    loop_var: __aws_subnet_item
    index_var: __aws_subnet_index
  loop: "{{ infra__vpc_private_subnets_info | union(infra__vpc_public_subnets_info) }}"

- name: Set up AWS Public Network infrastructure
  when: not (infra__tunnel and not infra__public_endpoint_access) and infra__aws_subnet_ids is undefined # L0 (all public) or L1 (public/private)
  block:
    - name: Create AWS Internet Gateway (IGW)
      community.aws.ec2_vpc_igw:
        vpc_id: "{{ infra__aws_vpc_id }}"
        region: "{{ infra__region }}"
        state: present
        tags: "{{ infra__tags | combine({ 'Name': infra__aws_igw_name }, recursive=True) }}"
      register: __aws_igw

    - name: Set fact for AWS IGW ID
      when: __aws_igw.gateway_id is defined
      ansible.builtin.set_fact:
        infra__aws_igw_id: "{{ __aws_igw.gateway_id }}"

    - name: Create AWS VPC Public Subnets
      amazon.aws.ec2_vpc_subnet:
        region: "{{ infra__region }}"
        vpc_id: "{{ infra__aws_vpc_id }}"
        cidr: "{{ __aws_public_subnet_item.cidr }}"
        state: present
        tags: "{{ infra__tags | combine(__aws_public_subnet_item.tags, recursive=True) }}"
        map_public: yes
        az: "{{ __aws_az_info.availability_zones[__aws_subnet_index % infra__aws_vpc_az_count | int].zone_name }}"
      loop_control:
        loop_var: __aws_public_subnet_item
        index_var: __aws_subnet_index
      loop: "{{ infra__vpc_public_subnets_info }}"
      register: __aws_public_subnets

    - name: Set fact for AWS Public Subnet IDs
      ansible.builtin.set_fact:
        infra__aws_public_subnet_ids: "{{ infra__aws_public_subnet_ids | default([]) | union([__aws_subnet_item.subnet.id | default('')]) }}"
      loop_control:
        loop_var: __aws_subnet_item
      loop: "{{ __aws_public_subnets.results }}"

    - name: List the Route Tables for the AWS VPC
      community.aws.ec2_vpc_route_table_info:
        region: "{{ infra__region }}"
        filters:
          vpc-id: "{{ infra__aws_vpc_id }}"
      register: __aws_route_table_list

    - name: Configure the Public Route Table for the AWS VPC
      community.aws.ec2_vpc_route_table:
        region: "{{ infra__region }}"
        vpc_id: "{{ infra__aws_vpc_id }}"
        route_table_id: "{{ __aws_route_table_id }}"
        lookup: id
        state: present
        tags: "{{ infra__tags | combine({ 'Name': infra__aws_public_route_table_name }, recursive=True) }}"
        routes:
          - dest: "0.0.0.0/0"
            gateway_id: "{{ infra__aws_igw_id }}"
        subnets: "{{ infra__aws_public_subnet_ids }}"
      vars:
        __aws_route_table_id: "{{ __aws_route_table_list.route_tables | json_query(__aws_rtb_jq) | flatten | first }}"
        __aws_rtb_jq: "[*].associations[?main == `true` ].route_table_id"

    - name: Set facts for AWS Subnet IDs with Public Subnet details if not CCM Tunneled
      when: not infra__tunnel
      ansible.builtin.set_fact:
        infra__aws_subnet_ids: "{{ infra__aws_public_subnet_ids }}"

- name: Setup AWS Private Networking infrastructure
  when: infra__tunnel and infra__aws_subnet_ids is undefined # L1 (public/private) or L2 (all private)
  block:
    - name: Create AWS VPC Private Subnets
      amazon.aws.ec2_vpc_subnet:
        region: "{{ infra__region }}"
        vpc_id: "{{ infra__aws_vpc_id }}"
        cidr: "{{ __aws_private_subnet_item.cidr }}"
        state: present
        tags: "{{ infra__tags | combine(__aws_private_subnet_item.tags, recursive = true) }}"
        map_public: no
        az: "{{ __aws_az_info.availability_zones[__aws_subnet_index % infra__aws_vpc_az_count | int].zone_name }}"
      loop_control:
        loop_var: __aws_private_subnet_item
        index_var: __aws_subnet_index
        label: "{{ __aws_private_subnet_item.name }}"
      loop: "{{ infra__vpc_private_subnets_info }}"
      register: __aws_private_subnets

    - name: Set fact for AWS Private Subnet IDs
      ansible.builtin.set_fact:
        infra__aws_private_subnet_ids: "{{ infra__aws_private_subnet_ids | default([]) | union([__aws_subnet_item.subnet.id | default('')]) }}"
      loop_control:
        loop_var: __aws_subnet_item
      loop: "{{ __aws_private_subnets.results }}"

    - name: Create Network Gateways (NAT) and allocate Elastic IP Addresses (EIP) for the AWS VPC
      community.aws.ec2_vpc_nat_gateway:
        state: present
        subnet_id: "{{ __aws_public_subnet_id }}"
        wait: true
        if_exist_do_not_create: true
        region: "{{ infra__region }}"
        tags: "{{ infra__tags | combine({ 'Name': '-'.join([infra__aws_nat_gateway_name, __aws_public_subnet_index | string]) }, recursive=True) }}"
      loop_control:
        loop_var: __aws_public_subnet_id
        index_var: __aws_public_subnet_index
      loop: "{{ infra__aws_public_subnet_ids }}"
      register: __aws_ngws

    - name: Configure Private Route Tables for the AWS VPC
      community.aws.ec2_vpc_route_table:
        vpc_id: "{{ infra__aws_vpc_id }}"
        region: "{{ infra__region }}"
        tags: "{{ infra__tags | combine({ 'Name': '-'.join([infra__aws_private_route_table_name, __aws_private_subnet_id_index | string]) }, recursive=True) }}"
        subnets: "{{ __aws_private_subnet_id_item }}"
        routes:
        - dest: "0.0.0.0/0"
          nat_gateway_id:  "{{ __aws_ngws.results[ __aws_private_subnet_id_index % __aws_ngws.results | length ].nat_gateway_id }}"
      loop_control:
        loop_var: __aws_private_subnet_id_item
        index_var: __aws_private_subnet_id_index
      loop: "{{ infra__aws_private_subnet_ids }}"

    - name: Set fact for AWS Subnet IDs
      ansible.builtin.set_fact:
        infra__aws_subnet_ids: "{{ infra__aws_public_subnet_ids | union(infra__aws_private_subnet_ids) }}"

- name: Create Security Groups
  amazon.aws.ec2_group:
    state: present
    region: "{{ infra__region }}"
    vpc_id: "{{ infra__aws_vpc_id }}"
    name: "{{ __security_group_name_item }}"
    description: "{{ __security_group_name_item }}"
    tags: "{{ infra__tags | combine({ 'Name': __security_group_name_item }, recursive=True) }}"
    rules:  "{{ infra__aws_security_group_rules | union([rule])}}"
  vars:
    rule:
      proto: all
      group_name: "{{ __security_group_name_item }}"
  loop_control:
    loop_var: __security_group_name_item
  loop:
    - "{{ infra__security_group_knox_name }}"
    - "{{ infra__security_group_default_name }}"
  register: __aws_security_group_info

- name: Set fact for Security Group IDs
  ansible.builtin.set_fact:
    infra__aws_security_group_knox_id: "{{ __aws_security_group_info | community.general.json_query(knox) | first }}"
    infra__aws_security_group_default_id: "{{ __aws_security_group_info | community.general.json_query(default) | first }}"
  vars:
    knox: "results[?group_name=='{{ infra__security_group_knox_name }}'].group_id"
    default: "results[?group_name=='{{ infra__security_group_default_name }}'].group_id"
