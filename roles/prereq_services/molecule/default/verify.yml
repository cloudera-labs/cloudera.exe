# Copyright 2024 Cloudera, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
- name: Verify
  hosts: all
  gather_facts: true
  vars:
    unnecessary_services:
      - bluetooth
      - cups
      - postfix
  tasks:
    - name: Populate service facts
      ansible.builtin.service_facts:

    # Check 1 - confirm that the unwanted services are stopped
    - name: Confirm that unnecessary services are stopped
      when: "__service + '.service' in ansible_facts.services"
      ansible.builtin.assert:
        that:
          - ansible_facts.services[__service + '.service'].state != 'running'
        fail_msg: "Services is in running state. Should be stopped."
      loop_control:
        loop_var: __service
      loop: "{{ unnecessary_services }}"

    # Check 2 - confirm that nscd is running
    - name: Confirm that nscd service is running
      ansible.builtin.assert:
        that:
          - ansible_facts.services['nscd.service'].state == 'running'
        fail_msg: "ncsd services should be in running state. Currently '{{ ansible_facts.services['nscd.service'].state }}'."
