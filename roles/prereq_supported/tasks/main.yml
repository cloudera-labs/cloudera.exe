---
# Copyright 2025 Cloudera, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- name: Gather distribution details
  ansible.builtin.setup:
    gather_subset: distribution

- name: Assert OS support for Cloudera Runtime and Manager versions
  ansible.builtin.assert:
    that:
      - supported_cms |
        selectattr('family', 'eq', prereq_supported_distribution_map[ansible_facts['distribution']] | default(ansible_facts['distribution'])) |
        selectattr('version', 'eq', ansible_facts['distribution_version']) |
        length > 0
      - supported_runtime |
        selectattr('family', 'eq', prereq_supported_distribution_map[ansible_facts['distribution']] | default(ansible_facts['distribution'])) |
        selectattr('version', 'eq', ansible_facts['distribution_version']) |
        length > 0
    fail_msg: "OS {{ ansible_facts['distribution'] }}-{{ ansible_facts['distribution_version'] }} not supported."
  vars:
    supported_cms: "{{ lookup('cloudera.exe.supported', 'operating_systems', product='cloudera_manager', version=cloudera_manager_version) }}"
    supported_runtime: "{{ lookup('cloudera.exe.supported', 'operating_systems', product='cloudera_runtime', version=cloudera_runtime_version) }}"

- name: Assert OS, Cloudera Manager, and Cloudera Runtime support for Cloudera Data Services version
  when: cloudera_data_services_version is defined
  vars:
    supported_ecs: "{{ lookup('cloudera.exe.supported', 'products', 'operating_systems', product='cloudera_data_services', version=cloudera_data_services_version) }}"
  block:
    - name: Assert OS support for Cloudera Data Services version
      ansible.builtin.assert:
        that:
          - supported_ecs |
            selectattr('family', 'defined') |
            selectattr('family', 'eq', prereq_supported_distribution_map[ansible_facts['distribution']] | default(ansible_facts['distribution'])) |
            selectattr('version', 'eq', ansible_facts['distribution_version']) |
            length > 0
        fail_msg: "OS {{ ansible_facts['distribution'] }}-{{ ansible_facts['distribution_version'] }} not supported."

    - name: Assert Cloudera Runtime and Manager support for Cloudera Data Services version
      ansible.builtin.assert:
        that:
          - supported_ecs |
            selectattr('product_name', 'defined') |
            selectattr('product_name', 'eq', 'CDP Private Cloud Base') |
            selectattr('version', 'eq', cloudera_runtime_version) |
            length > 0
          - supported_ecs |
            selectattr('product_name', 'defined') |
            selectattr('product_name', 'eq', 'Cloudera Manager') |
            selectattr('version', 'eq', cloudera_manager_version) |
            length > 0
        fail_msg: >
          Data Services {{ cloudera_data_services_version }} not supported for
          Runtime {{ cloudera_runtime_version }} and/or
          Manager {{ cloudera_manager_version }}
